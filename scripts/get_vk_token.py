#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è VK Access Token

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π access token –¥–ª—è VK API,
–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ.

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
1. –°–æ–∑–¥–∞–π—Ç–µ Standalone-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ https://id.vk.com/
   (–° 2024 –≥–æ–¥–∞ VK –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É VK ID)
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π access_token –≤ .env —Ñ–∞–π–ª
"""

import webbrowser
import urllib.parse
from http.server import HTTPServer, BaseHTTPRequestHandler
import sys

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
VK_APP_ID = None  # –ë—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
VK_REDIRECT_URI = 'https://oauth.vk.com/blank.html'  # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π redirect URI VK

# Permissions (scope) –¥–ª—è VK API
# video - –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
# offline - –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (–Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç)
SCOPE = 'video,offline'

# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
access_token = None


def get_token_from_browser():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Ä—É—á–Ω—É—é)"""
    print("\n" + "="*60)
    print("üìã –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Access Token:")
    print("="*60)
    print()
    print("1. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞:")
    print("   https://oauth.vk.com/blank.html#access_token=...")
    print()
    print("2. –í –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å—ë, —á—Ç–æ –∏–¥—ë—Ç")
    print("   –ü–û–°–õ–ï '#access_token=' –∏ –î–û '&expires_in'")
    print()
    print("3. –ü—Ä–∏–º–µ—Ä URL:")
    print("   https://oauth.vk.com/blank.html#access_token=vk1.a.ABCD...XYZ&expires_in=0&user_id=123456")
    print()
    print("4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω:")
    print("   vk1.a.ABCD...XYZ")
    print()
    print("="*60)
    print()
    
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω
    access_token = input("–í—Å—Ç–∞–≤—å—Ç–µ Access Token —Å—é–¥–∞: ").strip()
    
    if not access_token:
        print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
        return None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞
    if not (access_token.startswith('vk1.') or len(access_token) > 50):
        print("‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ç–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º.")
        confirm = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): ").lower()
        if confirm != 'y':
            return None
    
    return access_token


def get_vk_access_token():
    """–ü–æ–ª—É—á–∏—Ç—å VK Access Token —á–µ—Ä–µ–∑ OAuth"""
    global VK_APP_ID
    
    print("="*60)
    print("üîë –ü–æ–ª—É—á–µ–Ω–∏–µ VK Access Token")
    print("="*60)
    print()
    
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å APP ID
    print("üì± –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ VK ID")
    print("-" * 60)
    print("1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://id.vk.com/")
    print("2. –ù–∞–∂–º–∏—Ç–µ '–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'")
    print("3. –¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: 'Standalone-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'")
    print("4. –ù–∞–∑–≤–∞–Ω–∏–µ: 'Fanout Publisher' (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)")
    print("5. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: '–û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏' –∏–ª–∏ '–î—Ä—É–≥–æ–µ'")
    print("6. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'")
    print("7. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ 'ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è'")
    print()
    print("‚ÑπÔ∏è  –° 2024 –≥–æ–¥–∞ VK –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É VK ID!")
    print()
    
    VK_APP_ID = input("–í–≤–µ–¥–∏—Ç–µ ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ").strip()
    
    if not VK_APP_ID:
        print("‚ùå –û—à–∏–±–∫–∞: APP ID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        sys.exit(1)
    
    print()
    print("üìù –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redirect URI")
    print("-" * 60)
    print("1. –í —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:")
    print("   - –ë–∞–∑–æ–≤—ã–π –¥–æ–º–µ–Ω: oauth.vk.com")
    print("   - –î–æ–≤–µ—Ä–µ–Ω–Ω—ã–π Redirect URI: https://oauth.vk.com/blank.html")
    print("2. –ù–∞–∂–º–∏—Ç–µ '–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'")
    print("3. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ 'ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è'")
    print()
    print("‚ÑπÔ∏è  –° 2024 –≥–æ–¥–∞ VK —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è Redirect URI!")
    print()
    
    input("–ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–¥–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–∫–æ–ø–∏—Ä—É–µ—Ç–µ ID... ")
    
    # –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä—É–µ–º OAuth URL
    print()
    print("üåê –®–∞–≥ 3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è")
    print("-" * 60)
    
    auth_params = {
        'client_id': VK_APP_ID,
        'display': 'page',
        'redirect_uri': VK_REDIRECT_URI,
        'scope': SCOPE,
        'response_type': 'token',  # Implicit Flow - —Ç–æ–∫–µ–Ω –≤ fragment
        'v': '5.131'
    }
    
    auth_url = f"https://oauth.vk.com/authorize?{urllib.parse.urlencode(auth_params)}"
    
    print("–°–µ–π—á–∞—Å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...")
    print(f"–ï—Å–ª–∏ –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤—Ä—É—á–Ω—É—é:")
    print()
    print(auth_url)
    print()
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
    webbrowser.open(auth_url)
    
    print("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ...")
    print()
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–Ω —Å–∫–æ–ø–∏—Ä—É–µ—Ç –∏–∑ URL)
    access_token = get_token_from_browser()
    
    if access_token:
        print("\n" + "="*60)
        print("‚úÖ VK Access Token —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!")
        print("="*60)
        print(f"\nAccess Token:")
        print(access_token)
        print("\n" + "="*60)
        print("üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Access Token –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª:")
        print(f"VK_ACCESS_TOKEN={access_token}")
        print("="*60 + "\n")
        print("\nüí° –°–æ–≤–µ—Ç: –≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –±–µ—Å—Å—Ä–æ—á–Ω—ã–π, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ!")
        return access_token
    else:
        print("\n‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω")
        print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
        sys.exit(1)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    try:
        get_vk_access_token()
    except KeyboardInterrupt:
        print("\n\n‚ùå –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()

